<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dbdicom.manager &mdash; dbdicom 1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> dbdicom
            <img src="../../_static/sheffield-logo.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">GETTING STARTED</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">dbdicom</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dbdicom.manager</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dbdicom.manager</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Maintains an index of all files on disk.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">timeit</span>
<span class="c1">#from tkinter import N</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">dbdicom.message</span> <span class="kn">import</span> <span class="n">StatusBar</span><span class="p">,</span> <span class="n">Dialog</span>
<span class="kn">import</span> <span class="nn">dbdicom.utils.files</span> <span class="k">as</span> <span class="nn">filetools</span>
<span class="kn">import</span> <span class="nn">dbdicom.utils.dcm4che</span> <span class="k">as</span> <span class="nn">dcm4che</span>
<span class="kn">import</span> <span class="nn">dbdicom.ds.dataset</span> <span class="k">as</span> <span class="nn">dbdataset</span>
<span class="kn">from</span> <span class="nn">dbdicom.ds.create</span> <span class="kn">import</span> <span class="n">read_dataset</span><span class="p">,</span> <span class="n">SOPClass</span><span class="p">,</span> <span class="n">new_dataset</span>

<div class="viewcode-block" id="DatabaseCorrupted"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.DatabaseCorrupted">[docs]</a><span class="k">class</span> <span class="nc">DatabaseCorrupted</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="Manager"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager">[docs]</a><span class="k">class</span> <span class="nc">Manager</span><span class="p">():</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Programming interface for reading and writing a DICOM folder.&quot;&quot;&quot;</span>

    <span class="c1"># The column labels of the register</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>    
        <span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;SOPClassUID&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;InstanceNumber&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;ImageOrientationPatient&#39;</span><span class="p">,</span> <span class="s1">&#39;ImagePositionPatient&#39;</span><span class="p">,</span> <span class="s1">&#39;PixelSpacing&#39;</span><span class="p">,</span> <span class="s1">&#39;SliceThickness&#39;</span><span class="p">,</span> <span class="s1">&#39;SliceLocation&#39;</span><span class="p">,</span> <span class="s1">&#39;AcquisitionTime&#39;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="Manager.default"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.default">[docs]</a>    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">]</span></div>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataframe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">StatusBar</span><span class="p">(),</span> <span class="n">dialog</span><span class="o">=</span><span class="n">Dialog</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise the folder with a path and objects to message to the user.</span>
<span class="sd">        </span>
<span class="sd">        When used inside a GUI, status and dialog should be instances of the status bar and </span>
<span class="sd">        dialog class defined in `wezel`.</span>

<span class="sd">        path = None: The index manages data in memory</span>
<span class="sd">        dataframe = None: no database open</span>
<span class="sd">        &quot;&quot;&quot;</span>  
        <span class="k">if</span> <span class="n">dataframe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[],</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="c1"># THIS NEEDS A MECHANISM TO PREVENT ANOTHER Manager to open the same database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span> <span class="o">=</span> <span class="n">dialog</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="n">dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pause_extensions</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Manager.scan"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.scan">[docs]</a>    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unzip</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads all files in the folder and summarises key attributes in a table for faster access.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c1">#       Take unzip out until test is developed - less essential feature</span>
<span class="c1">#        if unzip:</span>
<span class="c1">#            filetools._unzip_files(self.path, self.status)</span>

        <span class="c1">#self.read_dataframe()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[],</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">return</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">filetools</span><span class="o">.</span><span class="n">all_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">read_dataframe</span><span class="p">(</span>
            <span class="n">files</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;NumberOfFrames&#39;</span><span class="p">],</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> 
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> 
            <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Reading database..&#39;</span><span class="p">,</span> 
            <span class="n">images_only</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">[</span><span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">[</span><span class="s1">&#39;placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># No support for multiframe data at the moment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multiframe_to_singleframe</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;NumberOfFrames&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Create placeholder rows for unsaved changes</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">removed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df</span><span class="o">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="n">df</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_split_series</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="k">def</span> <span class="nf">_split_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split series with multiple SOP Classes.</span>

<span class="sd">        If a series contain instances from different SOP Classes, </span>
<span class="sd">        these are separated out into multiple series with identical SOP Classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">removed</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>

        <span class="c1"># For each series, check if there are multiple</span>
        <span class="c1"># SOP Classes in the series and split them if yes.</span>
        <span class="n">all_series</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">SeriesInstanceUID</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_series</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Splitting series with multiple data types&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_series</span><span class="p">),</span> <span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">df_series</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">SeriesInstanceUID</span> <span class="o">==</span> <span class="n">series</span><span class="p">]</span>
            <span class="n">sop_classes</span> <span class="o">=</span> <span class="n">df_series</span><span class="o">.</span><span class="n">SOPClassUID</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sop_classes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># For each sop_class, create a new series and move all</span>
                <span class="c1"># instances of that sop_class to the new series</span>
                <span class="n">study</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
                <span class="n">series_desc</span> <span class="o">=</span> <span class="n">df_series</span><span class="o">.</span><span class="n">SeriesDescription</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sop_class</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sop_classes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="n">series_desc</span> <span class="o">+</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
                    <span class="n">new_series</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_series</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">study</span><span class="p">,</span> <span class="n">SeriesDescription</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
                    <span class="n">df_sop_class</span> <span class="o">=</span> <span class="n">df_series</span><span class="p">[</span><span class="n">df_series</span><span class="o">.</span><span class="n">SOPClassUID</span> <span class="o">==</span> <span class="n">sop_class</span><span class="p">]</span>
                    <span class="n">instances</span> <span class="o">=</span> <span class="n">df_sop_class</span><span class="o">.</span><span class="n">SOPInstanceUID</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">moved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_to_series</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">new_series</span><span class="p">)</span>
                    

    <span class="k">def</span> <span class="nf">_multiframe_to_singleframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts all multiframe files in the folder into single-frame files.</span>
<span class="sd">        </span>
<span class="sd">        Reads all the multi-frame files in the folder,</span>
<span class="sd">        converts them to singleframe files, and delete the original multiframe file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Low priority - we are not creating multiframe data from scratch yet</span>
            <span class="c1"># So will always be loaded from disk initially where the solution exists. </span>
            <span class="c1"># Solution: save data in a temporary file, use the filebased conversion, </span>
            <span class="c1"># the upload the solution and delete the temporary file.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Multi-frame to single-frame conversion does not yet exist from data in memory&#39;</span><span class="p">)</span>
        <span class="n">singleframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">NumberOfFrames</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> 
        <span class="n">multiframe</span> <span class="o">=</span> <span class="n">singleframe</span> <span class="o">==</span> <span class="kc">False</span>
        <span class="n">nr_multiframe</span> <span class="o">=</span> <span class="n">multiframe</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nr_multiframe</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">cnt</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">relpath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">[</span><span class="n">multiframe</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">cnt</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Converting multiframe file &quot;</span> <span class="o">+</span> <span class="n">relpath</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="n">nr_multiframe</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="c1"># Create these in the dbdicom folder, not in the original folder.</span>
                <span class="c1">#</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">relpath</span><span class="p">)</span>
                <span class="n">singleframe_files</span> <span class="o">=</span> <span class="n">dcm4che</span><span class="o">.</span><span class="n">split_multiframe</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> 
                <span class="k">if</span> <span class="n">singleframe_files</span> <span class="o">!=</span> <span class="p">[]:</span>            
                    <span class="c1"># add the single frame files to the dataframe</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">read_dataframe</span><span class="p">(</span><span class="n">singleframe_files</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="n">df</span><span class="p">])</span>
                    <span class="c1"># delete the original multiframe </span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                <span class="c1"># drop the file also if the conversion has failed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">relpath</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pkl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns the file path of the .pkl file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> 

<div class="viewcode-block" id="Manager.npy"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.npy">[docs]</a>    <span class="k">def</span> <span class="nf">npy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="c1"># Not in use - default path for temporary storage in numoy format</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;dbdicom_npy&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> 
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">uid</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">file</span></div>

    <span class="k">def</span> <span class="nf">_write_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Writes the dataFrame as a .pkl file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pkl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reads the dataFrame from a .pkl file &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pkl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<div class="viewcode-block" id="Manager.write_csv"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.write_csv">[docs]</a>    <span class="k">def</span> <span class="nf">write_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Writes the dataFrame as a .csv file for visual inspection&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>

<div class="viewcode-block" id="Manager.filepath"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.filepath">[docs]</a>    <span class="k">def</span> <span class="nf">filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the full filepath for a given relative path.</span>
<span class="sd">        </span>
<span class="sd">        Returns None for data that live in memory only.&quot;&quot;&quot;</span>
        <span class="c1"># Needs a formal test for completeness</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Manager.filepaths"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.filepaths">[docs]</a>    <span class="k">def</span> <span class="nf">filepaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of full filepaths for all dicom files in the folder&quot;&quot;&quot;</span>
        <span class="c1"># Needs a formal test for completeness</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Manager.open"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unzip</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Opens a DICOM folder for read and write.</span>
<span class="sd">        </span>
<span class="sd">        Reads the contents of the folder and summarises all DICOM files</span>
<span class="sd">        in a dataframe for faster access next time. The dataframe is saved </span>
<span class="sd">        as a pkl file when the folder is closed with `.close()`. </span>
<span class="sd">        All non-DICOM files in the folder are ignored.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            path: The full path to the directory that is to be opened.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot open database - no path is specified&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pkl</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_df</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># If the file is corrupted, delete it and load again</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pkl</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">unzip</span><span class="o">=</span><span class="n">unzip</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">unzip</span><span class="o">=</span><span class="n">unzip</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Manager.type"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.type">[docs]</a>    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Is the UID a patient, study, series or dataset&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="s1">&#39;Database&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">uid</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">uid</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># uid does not exists in the database</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,:]</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">uid</span><span class="p">])]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Patient&#39;</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Study&#39;</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Series&#39;</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Instance&#39;</span></div>


<div class="viewcode-block" id="Manager.tree"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.tree">[docs]</a>    <span class="k">def</span> <span class="nf">tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot build tree - no database open&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">removed</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;PatientName&#39;</span><span class="p">,</span><span class="s1">&#39;StudyDate&#39;</span><span class="p">,</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">,</span><span class="s1">&#39;InstanceNumber&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">database</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">}</span>
        <span class="n">database</span><span class="p">[</span><span class="s1">&#39;patients&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">uid_patient</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">PatientID</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">patient</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="n">uid_patient</span><span class="p">}</span>
            <span class="n">database</span><span class="p">[</span><span class="s1">&#39;patients&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patient</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">df_patient</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">PatientID</span> <span class="o">==</span> <span class="n">uid_patient</span><span class="p">]</span>
                <span class="n">patient</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_patient</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">patient</span><span class="p">[</span><span class="s1">&#39;studies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">uid_study</span> <span class="ow">in</span> <span class="n">df_patient</span><span class="o">.</span><span class="n">StudyInstanceUID</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                    <span class="n">study</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="n">uid_study</span><span class="p">}</span>
                    <span class="n">patient</span><span class="p">[</span><span class="s1">&#39;studies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">study</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">df_study</span> <span class="o">=</span> <span class="n">df_patient</span><span class="p">[</span><span class="n">df_patient</span><span class="o">.</span><span class="n">StudyInstanceUID</span> <span class="o">==</span> <span class="n">uid_study</span><span class="p">]</span>
                        <span class="n">study</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_study</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">study</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">uid_sery</span> <span class="ow">in</span> <span class="n">df_study</span><span class="o">.</span><span class="n">SeriesInstanceUID</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                            <span class="n">series</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="n">uid_sery</span><span class="p">}</span>
                            <span class="n">study</span><span class="p">[</span><span class="s1">&#39;series&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">df_series</span> <span class="o">=</span> <span class="n">df_study</span><span class="p">[</span><span class="n">df_study</span><span class="o">.</span><span class="n">SeriesInstanceUID</span> <span class="o">==</span> <span class="n">uid_sery</span><span class="p">]</span>
                                <span class="n">series</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_series</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">database</span></div>


<div class="viewcode-block" id="Manager.keys"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">patient</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">study</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">dropna</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of indices for all dicom datasets managed by the index.</span>
<span class="sd">        </span>
<span class="sd">        These indices are strings with unique relative paths </span>
<span class="sd">        that either link to an existing file in the database or can be used for </span>
<span class="sd">        writing a database that is in memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cant return dicom files - no database open&#39;</span><span class="p">)</span>

        <span class="c1"># If no arguments are provided</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">patient</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">study</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;Database&#39;</span> <span class="ow">in</span> <span class="n">uid</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="s1">&#39;Database&#39;</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="n">dropna</span><span class="p">)</span>

        <span class="n">not_deleted</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">removed</span> <span class="o">==</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="s1">&#39;Database&#39;</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">not_deleted</span><span class="p">[</span><span class="n">not_deleted</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dropna</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span><span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">keys</span>

        <span class="c1"># If arguments are provided, create a list of unique datasets</span>
        <span class="c1"># keys = []</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="p">[</span><span class="n">uid</span><span class="p">]</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">uid</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">not_deleted</span>
        <span class="k">if</span> <span class="n">patient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">PatientID</span><span class="o">==</span><span class="n">patient</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">not_deleted</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">patient</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">patient</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">PatientID</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">patient</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">not_deleted</span>
        <span class="k">if</span> <span class="n">study</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">study</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">StudyInstanceUID</span><span class="o">==</span><span class="n">study</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">not_deleted</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">study</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">study</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">StudyInstanceUID</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">study</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">not_deleted</span>
        <span class="k">if</span> <span class="n">series</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">SeriesInstanceUID</span><span class="o">==</span><span class="n">series</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">not_deleted</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">series</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">SeriesInstanceUID</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">not_deleted</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">SOPInstanceUID</span><span class="o">==</span><span class="n">instance</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">not_deleted</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instance</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">SOPInstanceUID</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">not_deleted</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dropna</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span><span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">keys</span></div>

<div class="viewcode-block" id="Manager.value"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.value">[docs]</a>    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">column</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Manager.parent"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.parent">[docs]</a>    <span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># For consistency with other definitions</span>
        <span class="c1"># Allow uid to be list and return list if multiple parents are found</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the UID of the parent object&quot;&quot;&quot;</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Database&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="Manager.filter"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">uids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">uids</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">uids</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">uids</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span> <span class="o">==</span> <span class="n">vals</span><span class="p">]</span></div>
        <span class="c1">#return [id for id in uids if function(self.get_values(attr, uid=id), vals)]</span>


<div class="viewcode-block" id="Manager.filter_instances"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.filter_instances">[docs]</a>    <span class="k">def</span> <span class="nf">filter_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="n">vals</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span></div>


<div class="viewcode-block" id="Manager.instances"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.instances">[docs]</a>    <span class="k">def</span> <span class="nf">instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">images</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sortby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sortby</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;InstanceNumber&#39;</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span> <span class="n">sortby</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">]]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">SOPInstanceUID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span><span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_instances</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">images</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s1">&#39;Rows&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Manager.series"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.series">[docs]</a>    <span class="k">def</span> <span class="nf">series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sortby</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sortby</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">sortby</span> <span class="o">=</span> <span class="p">[</span><span class="n">sortby</span><span class="p">]</span>
            <span class="n">sortby</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span> <span class="n">sortby</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">SeriesInstanceUID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span>
        <span class="n">uids</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Manager.studies"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.studies">[docs]</a>    <span class="k">def</span> <span class="nf">studies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">sortby</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PatientName&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span> <span class="n">sortby</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">StudyInstanceUID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span>
        <span class="n">uids</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Manager.patients"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.patients">[docs]</a>    <span class="k">def</span> <span class="nf">patients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">sortby</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PatientName&#39;</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span> <span class="n">sortby</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;PatientID&#39;</span><span class="p">]]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sortby</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">PatientID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span><span class="s1">&#39;PatientID&#39;</span><span class="p">]</span>
        <span class="n">uids</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Manager.pause_extensions"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.pause_extensions">[docs]</a>    <span class="k">def</span> <span class="nf">pause_extensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pause_extensions</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Manager.resume_extensions"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.resume_extensions">[docs]</a>    <span class="k">def</span> <span class="nf">resume_extensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pause_extensions</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span></div>


<div class="viewcode-block" id="Manager.extend"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.extend">[docs]</a>    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pause_extensions</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">return</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="n">df</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Manager.new_patient"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.new_patient">[docs]</a>    <span class="k">def</span> <span class="nf">new_patient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s1">&#39;Database&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Allow multiple to be made at the same time</span>

        <span class="n">PatientName</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;PatientName&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;PatientName&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s1">&#39;New Patient&#39;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">PatientName</span>

        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span></div>


<div class="viewcode-block" id="Manager.new_study"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.new_study">[docs]</a>    <span class="k">def</span> <span class="nf">new_study</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Allow multiple to be made at the same time</span>

        <span class="n">StudyDescription</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;StudyDescription&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;StudyDescription&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s1">&#39;New Study&#39;</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_patient</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Patient&#39;</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_patient</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">patient</span><span class="o">=</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">StudyDescription</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># New patient without studies - use existing row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Patient with existing study - create new row</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span></div>


<div class="viewcode-block" id="Manager.new_series"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.new_series">[docs]</a>    <span class="k">def</span> <span class="nf">new_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Allow multiple to be made at the same time</span>

        <span class="n">SeriesDescription</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;SeriesDescription&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;SeriesDescription&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s1">&#39;New Series&#39;</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_study</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Study&#39;</span><span class="p">:</span>
                <span class="c1">#parent = self.studies(parent)[0]</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_study</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">study</span><span class="o">=</span><span class="n">parent</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># data = self.value(key, self.columns)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">SeriesDescription</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">()[</span><span class="mi">10</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># New study without series - use existing row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Study with existing series - create new row</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">key</span></div>

    
<div class="viewcode-block" id="Manager.new_instance"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.new_instance">[docs]</a>    <span class="k">def</span> <span class="nf">new_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Allow multiple to be made at the same time</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_series</span><span class="p">()</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Series&#39;</span><span class="p">:</span>
                <span class="c1"># parent = self.series(parent)[0] </span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_series</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Find largest instance number</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span><span class="s1">&#39;InstanceNumber&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="n">n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">max_number</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># Populate attributes in index file</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span>
        <span class="c1">#data[10] = 1 + len(self.instances(parent))</span>
        <span class="c1">#data[10] = 1 + len(self.instances(keys=self.keys(series=parent)))</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">max_number</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># New series without instances - use existing row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Series with existing instances - create new row</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dataset</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">key</span></div>


    <span class="c1"># def in_database(self, uid):</span>
    <span class="c1">#     keys = self.keys(uid)</span>
    <span class="c1">#     return keys != []</span>


    <span class="c1"># def is_empty(self, instance):</span>
    <span class="c1">#     # Needs a unit test</span>
    <span class="c1">#     key = self.keys(instance)[0]</span>
    <span class="c1">#     if key in self.dataset:</span>
    <span class="c1">#         return False</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         file = self.filepath(key)</span>
    <span class="c1">#         if file is None:</span>
    <span class="c1">#             return True</span>
    <span class="c1">#         elif not os.path.exists(file):</span>
    <span class="c1">#             return True</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             return False</span>

<div class="viewcode-block" id="Manager.get_instance_dataset"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.get_instance_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">get_instance_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets a datasets for a single instance</span>
<span class="sd">        </span>
<span class="sd">        Datasets in memory will be returned.</span>
<span class="sd">        If they are not in memory, and the database exists on disk, they will be read from disk.</span>
<span class="sd">        If they are not in memory, and the database does not exist on disk, an exception is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
            <span class="c1"># If in memory, get from memory</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="c1"># If not in memory, read from disk</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># No dataset assigned yet</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>  <span class="c1"># New instance, series, study or patient </span>
            <span class="k">return</span> 
        <span class="k">return</span> <span class="n">read_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="p">)</span>  </div>


<div class="viewcode-block" id="Manager.get_dataset"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.get_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets a list of datasets for a single record</span>
<span class="sd">        </span>
<span class="sd">        Datasets in memory will be returned.</span>
<span class="sd">        If they are not in memory, and the database exists on disk, they will be read from disk.</span>
<span class="sd">        If they are not in memory, and the database does not exist on disk, an exception is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># empty record</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instance_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> 
            <span class="n">dataset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;Instance&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataset</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dataset</span></div>


    <span class="k">def</span> <span class="nf">_get_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function&quot;&quot;&quot;</span>

        <span class="c1">#ds = self._get_dataset(instances)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instance_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>


<div class="viewcode-block" id="Manager.series_header"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.series_header">[docs]</a>    <span class="k">def</span> <span class="nf">series_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attributes and values inherited from series, study and patient&quot;&quot;&quot;</span>

        <span class="n">attr_patient</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">]</span>
        <span class="n">attr_study</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">]</span>
        <span class="n">attr_series</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span> 

        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dbdataset</span><span class="o">.</span><span class="n">module_patient</span><span class="p">()</span> <span class="o">+</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">module_study</span><span class="p">()</span> <span class="o">+</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">module_series</span><span class="p">()))</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_values</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">study</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keys</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dbdataset</span><span class="o">.</span><span class="n">module_patient</span><span class="p">()</span> <span class="o">+</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">module_study</span><span class="p">()))</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_values</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="n">attr</span> <span class="o">+=</span> <span class="n">attr_series</span>
                <span class="n">vals</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">attr_series</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">]</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">patient</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">keys</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">module_patient</span><span class="p">()</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_values</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                    <span class="n">attr</span> <span class="o">+=</span> <span class="n">attr_study</span> <span class="o">+</span> <span class="n">attr_series</span>
                    <span class="n">vals</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">attr_study</span> <span class="o">+</span> <span class="n">attr_series</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">attr_patient</span> <span class="o">+</span> <span class="n">attr_study</span> <span class="o">+</span> <span class="n">attr_series</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vals</span></div>


<div class="viewcode-block" id="Manager.study_header"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.study_header">[docs]</a>    <span class="k">def</span> <span class="nf">study_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attributes and values inherited from series, study and patient&quot;&quot;&quot;</span>

        <span class="n">attr_patient</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">]</span>
        <span class="n">attr_study</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">]</span>

        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">study</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dbdataset</span><span class="o">.</span><span class="n">module_patient</span><span class="p">()</span> <span class="o">+</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">module_study</span><span class="p">()))</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_values</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">]</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">patient</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keys</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">module_patient</span><span class="p">()</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_values</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="n">attr</span> <span class="o">+=</span> <span class="n">attr_study</span>
                <span class="n">vals</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">attr_study</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">attr_patient</span> <span class="o">+</span> <span class="n">attr_study</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vals</span></div>


<div class="viewcode-block" id="Manager.patient_header"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.patient_header">[docs]</a>    <span class="k">def</span> <span class="nf">patient_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attributes and values inherited from series, study and patient&quot;&quot;&quot;</span>

        <span class="n">attr_patient</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">]</span>

        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">patient</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">module_patient</span><span class="p">()</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_values</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">attr_patient</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vals</span></div>


<div class="viewcode-block" id="Manager.set_instance_dataset"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.set_instance_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">set_instance_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot set multiple datasets to a single instance&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keys</span> <span class="o">==</span> <span class="p">[]:</span> <span class="c1"># instance does not exist</span>
                <span class="k">return</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">SOPClassUID</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
            <span class="k">return</span> <span class="n">key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the dataset has not yet been edited</span>
            <span class="c1"># find the placeholder row and copy the data</span>
            <span class="n">placeholder</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SOPInstanceUID</span> <span class="o">==</span> <span class="n">instance</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">placeholder</span><span class="p">)</span>
            <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="p">[</span><span class="n">placeholder</span><span class="p">]</span>
            <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#self.register.loc[placeholder, self.columns] = data</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># remove the current row and make the placeholder row current</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">placeholder</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
            <span class="k">return</span> <span class="n">placeholder</span></div>
            <span class="c1"># new_key = self.new_key()</span>
            <span class="c1"># self.dataset[new_key] = ds</span>

            <span class="c1"># self._new_data.append(data)</span>
            <span class="c1"># self._new_keys.append(new_key)</span>
            <span class="c1"># self.extend()</span>


<div class="viewcode-block" id="Manager.set_dataset"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.set_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">set_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parent_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_keys</span> <span class="o">=</span> <span class="n">keys</span>

        <span class="c1"># LOOKUP!!!</span>
        <span class="c1"># ELIMINATE</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">parent_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;Instance&#39;</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">set_instance_dataset</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">parent_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
           <span class="n">dataset</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="p">]</span>
         
        <span class="n">attr</span><span class="p">,</span> <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_header</span><span class="p">(</span><span class="n">parent_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">new_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">parent_keys</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">instances</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">SOPInstanceUID</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># Save dataset in new instance</span>

                <span class="c1"># Set parent modules</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>

                <span class="c1"># Set values in manager</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">parent_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">SOPClassUID</span>
                <span class="n">nrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">parent_keys</span><span class="p">,</span> <span class="s1">&#39;InstanceNumber&#39;</span><span class="p">)</span>
                <span class="n">nrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nrs</span> <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">nrs</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">nrs</span><span class="p">)</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                <span class="c1"># Add to database in memory</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                <span class="n">new_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">new_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_key</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span> <span class="c1"># If the dataset is already in the object</span>

                <span class="c1">#key = self.keys(instances[ind])[0]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">parent_keys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">SOPClassUID</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If the dataset has not yet been edited</span>
                    <span class="c1"># find the placeholder row and copy the data</span>
                    <span class="n">instance</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">SOPInstanceUID</span>
                    <span class="n">placeholder</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SOPInstanceUID</span> <span class="o">==</span> <span class="n">instance</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">placeholder</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="p">[</span><span class="n">placeholder</span><span class="p">]</span>
                    <span class="n">new_key</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1">#self.register.loc[new_key, self.columns] = data</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="c1"># remove the current row and make the placeholder row current</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>

                    <span class="c1"># self.register.at[key,&#39;removed&#39;] = True</span>

                    <span class="c1">#  # Add to database in memory</span>
                    <span class="c1"># new_key = self.new_key()</span>
                    <span class="c1"># self.dataset[new_key] = ds</span>
                    <span class="c1"># new_data.append(data)</span>
                    <span class="c1"># new_keys.append(new_key)</span>

        <span class="c1"># Update the dataframe in the index</span>

        <span class="c1"># If the series is empty and new instances have been added</span>
        <span class="c1"># then delete the row </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">parent_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_keys</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">parent_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;created&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">parent_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">parent_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">+=</span> <span class="n">new_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">+=</span> <span class="n">new_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span> </div>


    <span class="c1"># def in_memory(self, uid): # needs a test</span>

    <span class="c1">#     key = self.keys(uid)[0]</span>
    <span class="c1">#     return key in self.dataset</span>


<div class="viewcode-block" id="Manager.label"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.label">[docs]</a>    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a label to describe a row as Patient, Study, Series or Instance&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cant provide labels - no database open&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    
        <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="s1">&#39;Database&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Database: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Patient&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">patient</span><span class="o">=</span><span class="n">uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">PatientName</span>
            <span class="c1">#id = row.PatientID</span>
            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="c1">#label += &#39; [&#39; + str(id) + &#39;]&#39;</span>
            <span class="k">return</span> <span class="nb">type</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Study&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">study</span><span class="o">=</span><span class="n">uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">StudyDescription</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">StudyDate</span>
            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">descr</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
            <span class="k">return</span> <span class="nb">type</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Series&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SeriesDescription</span>
            <span class="n">nr</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">SeriesNumber</span>
            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  
            <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39; [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">descr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
            <span class="k">return</span> <span class="nb">type</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Instance&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">nr</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">InstanceNumber</span>
            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">SOPClass</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">SOPClassUID</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></div>


<div class="viewcode-block" id="Manager.print"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.print">[docs]</a>    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints a summary of the project folder to the terminal.&quot;&quot;&quot;</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------- DICOM FOLDER --------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DATABASE: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">patient</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="p">(</span><span class="s1">&#39;Database&#39;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  PATIENT [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">patient</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">study</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">studies</span><span class="p">(</span><span class="n">patient</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    STUDY [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">study</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">study</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      SERIES [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">series</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        Nr of instances: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">(</span><span class="n">series</span><span class="p">))))</span> </div>


<div class="viewcode-block" id="Manager.read"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the dataset from disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="c1">#if message is not None:</span>
            <span class="c1">#    self.status.progress(i, len(keys), message)</span>
            <span class="c1"># do not read if they are already in memory</span>
            <span class="c1"># this could overwrite changes made in memory only</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                <span class="n">instance_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">instance_uid</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="Manager.write"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writing data from memory to disk.</span>

<span class="sd">        This does nothing if the data are not in memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="c1"># if message is not None:</span>
            <span class="c1">#     self.status.progress(i, len(keys), message)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div>
        <span class="c1">#self.status.hide()</span>

<div class="viewcode-block" id="Manager.clear"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all data from memory&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># write to disk first so that any changes made in memory are not lost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># then delete the instances from memory</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> </div>

<div class="viewcode-block" id="Manager.close"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close an open database.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#if not self.is_open(): </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># This is the case where the database exists in memory only</span>
        <span class="c1"># Needs testing..</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">reply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">question</span><span class="p">(</span> 
                <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Closing DICOM folder&#39;</span><span class="p">,</span> 
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Save changes before closing?&#39;</span><span class="p">,</span>
                <span class="n">cancel</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">reply</span> <span class="o">==</span> <span class="s2">&quot;Cancel&quot;</span><span class="p">:</span> 
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">reply</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">directory</span><span class="p">(</span><span class="s1">&#39;Please enter the full path to an existing folder&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="c1">#self.save(&#39;Database&#39;)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">reply</span> <span class="o">==</span> <span class="s2">&quot;No&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_saved</span><span class="p">():</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">question</span><span class="p">(</span> 
                <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Closing DICOM folder&#39;</span><span class="p">,</span> 
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Save changes before closing?&#39;</span><span class="p">,</span>
                <span class="n">cancel</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">reply</span> <span class="o">==</span> <span class="s2">&quot;Cancel&quot;</span><span class="p">:</span> 
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">reply</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="c1">#self.save(&#39;Database&#39;)</span>
            <span class="k">elif</span> <span class="n">reply</span> <span class="o">==</span> <span class="s2">&quot;No&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_df</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="kc">None</span>            
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Manager.is_saved"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.is_saved">[docs]</a>    <span class="k">def</span> <span class="nf">is_saved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the folder is saved.</span>
<span class="sd">        </span>
<span class="sd">        Returns: </span>
<span class="sd">            True if the folder is saved and False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Needs a formal test for completeness</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">removed</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">created</span><span class="o">==</span><span class="kc">False</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">removed</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">created</span><span class="o">==</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">removed</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">created</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">placeholder</span><span class="o">==</span><span class="kc">False</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Manager.is_open"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.is_open">[docs]</a>    <span class="k">def</span> <span class="nf">is_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a database is currently open, either in memory or on disk</span>
<span class="sd">        </span>
<span class="sd">        Returns: </span>
<span class="sd">            True if a database is open and False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Needs a formal test for completeness</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Manager.delete"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes some datasets</span>
<span class="sd">        </span>
<span class="sd">        Deleted datasets are stashed and can be recovered with restore()</span>
<span class="sd">        Using save() will delete them permanently</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span><span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Manager.save"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Saving changes..&#39;</span><span class="p">)</span>

        <span class="n">no_placeholder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">placeholder</span><span class="o">==</span><span class="kc">False</span>
        <span class="n">created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">created</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">removed</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">no_placeholder</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">removed</span> <span class="o">&amp;</span> <span class="n">no_placeholder</span>
        <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">created</span> <span class="o">=</span> <span class="n">created</span> <span class="o">&amp;</span> <span class="n">rows</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="n">removed</span> <span class="o">&amp;</span> <span class="n">rows</span>
        <span class="n">created</span> <span class="o">=</span> <span class="n">created</span><span class="p">[</span><span class="n">created</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="n">removed</span><span class="p">[</span><span class="n">removed</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># delete datasets marked for removal</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">removed</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="c1"># delete in memory</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="c1"># delete on disk</span>
            <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span> 
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="c1"># and drop then from the dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">removed</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># for new or edited data, mark as saved and create placeholders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">created</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#df = self.register.loc[created, :].copy(deep=True)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">created</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">removed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df</span><span class="o">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="n">df</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_df</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span></div>


<div class="viewcode-block" id="Manager.restore"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.restore">[docs]</a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  

        <span class="n">no_placeholder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">placeholder</span><span class="o">==</span><span class="kc">False</span>
        <span class="n">created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">created</span> <span class="o">&amp;</span> <span class="n">no_placeholder</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">removed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">created</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">no_placeholder</span>
        <span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">created</span> <span class="o">=</span> <span class="n">created</span> <span class="o">&amp;</span> <span class="n">rows</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="n">removed</span> <span class="o">&amp;</span> <span class="n">rows</span>
        <span class="n">created</span> <span class="o">=</span> <span class="n">created</span><span class="p">[</span><span class="n">created</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="n">removed</span><span class="p">[</span><span class="n">removed</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># permanently delete newly created datasets</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">created</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="c1"># delete in memory</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="c1"># delete on disk</span>
            <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span> 
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">created</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># For those that are restored, create placeholders.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">removed</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">removed</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">removed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df</span><span class="o">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="n">df</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_df</span><span class="p">()</span></div>
        <span class="c1"># self.write()      </span>


<div class="viewcode-block" id="Manager.delete_studies"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.delete_studies">[docs]</a>    <span class="k">def</span> <span class="nf">delete_studies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">studies</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a list of studies&quot;&quot;&quot;</span>
        <span class="n">copy_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">copy_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">study</span> <span class="ow">in</span> <span class="n">studies</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">study</span><span class="o">=</span><span class="n">study</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span><span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># If this was the last study in the patient</span>
            <span class="c1"># keep the patient as an empty patient</span>
            <span class="n">patient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">]</span>
            <span class="n">patient</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">removed</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">PatientID</span> <span class="o">==</span> <span class="n">patient</span><span class="p">)</span>
            <span class="n">patient_studies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">StudyInstanceUID</span><span class="p">[</span><span class="n">patient</span><span class="p">]</span>
            <span class="n">patient_studies_cnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">patient_studies</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">patient_studies_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">]</span>
                <span class="n">copy_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">copy_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">+=</span> <span class="n">copy_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">+=</span> <span class="n">copy_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span></div>

      
<div class="viewcode-block" id="Manager.delete_series"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.delete_series">[docs]</a>    <span class="k">def</span> <span class="nf">delete_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a list of series&quot;&quot;&quot;</span>
        <span class="n">copy_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">copy_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sery</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">sery</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keys</span><span class="p">,</span><span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># If this was the last series in the study</span>
            <span class="c1"># keep the study as an empty study</span>
            <span class="n">study</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span>
            <span class="n">study</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">removed</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">StudyInstanceUID</span> <span class="o">==</span> <span class="n">study</span><span class="p">)</span>
            <span class="n">study_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SeriesInstanceUID</span><span class="p">[</span><span class="n">study</span><span class="p">]</span>
            <span class="n">study_series_cnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">study_series</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">study_series_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">]</span>
                <span class="n">copy_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">copy_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">+=</span> <span class="n">copy_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">+=</span> <span class="n">copy_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span></div>


<div class="viewcode-block" id="Manager.new_key"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.new_key">[docs]</a>    <span class="k">def</span> <span class="nf">new_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a new key&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;dbdicom&#39;</span><span class="p">,</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.dcm&#39;</span><span class="p">)</span> </div>


<div class="viewcode-block" id="Manager.copy_instance_to_series"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.copy_instance_to_series">[docs]</a>    <span class="k">def</span> <span class="nf">copy_instance_to_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_key</span><span class="p">,</span> <span class="n">target_keys</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy instances to another series&quot;&quot;&quot;</span>

        <span class="n">attributes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_header</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target_keys</span><span class="p">,</span><span class="s1">&#39;InstanceNumber&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="n">n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">max_number</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        
        <span class="c1">#copy_data = []</span>
        <span class="c1">#copy_keys = []</span>

        <span class="n">new_instance</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instance_dataset</span><span class="p">(</span><span class="n">instance_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">instance_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_instance</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SeriesDescription&#39;</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">max_number</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">instance_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span> 
                <span class="n">attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;InstanceNumber&#39;</span><span class="p">],</span> 
                <span class="n">values</span> <span class="o">+</span> <span class="p">[</span><span class="n">new_instance</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">max_number</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">new_key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># Get new data for the dataframe</span>
        <span class="c1">#copy_data.append(row)</span>
        <span class="c1">#copy_keys.append(new_key)</span>
        <span class="n">copy_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="n">copy_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_key</span><span class="p">]</span>

        <span class="c1"># Update the dataframe in the index</span>

        <span class="c1"># If the series is empty and new instances have been added</span>
        <span class="c1"># then delete the row </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">copy_keys</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;created&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">+=</span> <span class="n">copy_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">+=</span> <span class="n">copy_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">new_instance</span></div>


<div class="viewcode-block" id="Manager.copy_to_series"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.copy_to_series">[docs]</a>    <span class="k">def</span> <span class="nf">copy_to_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uids</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy instances to another series&quot;&quot;&quot;</span>

        <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

        <span class="n">attributes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_header</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target_keys</span><span class="p">,</span><span class="s1">&#39;InstanceNumber&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="n">n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">max_number</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        
        <span class="n">copy_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">copy_keys</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span>
        <span class="n">new_instances</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Copying to series..&#39;</span><span class="p">)</span>

            <span class="n">new_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span>
            <span class="n">instance_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">instance_uid</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_instances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SeriesDescription&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">max_number</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span> 
                    <span class="n">attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;InstanceNumber&#39;</span><span class="p">],</span> 
                    <span class="n">values</span> <span class="o">+</span> <span class="p">[</span><span class="n">new_instances</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">max_number</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">new_key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

            <span class="c1"># Get new data for the dataframe</span>
            <span class="n">copy_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">copy_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_key</span><span class="p">)</span>

        <span class="c1"># Update the dataframe in the index</span>

        <span class="c1"># If the series is empty and new instances have been added</span>
        <span class="c1"># then delete the row </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">copy_keys</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;created&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">+=</span> <span class="n">copy_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">+=</span> <span class="n">copy_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_instances</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_instances</span></div>


<div class="viewcode-block" id="Manager.copy_to_study"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.copy_to_study">[docs]</a>    <span class="k">def</span> <span class="nf">copy_to_study</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy series to another study&quot;&quot;&quot;</span>

        <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">study</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
        <span class="n">target_key</span> <span class="o">=</span> <span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">attributes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_header</span><span class="p">(</span><span class="n">target_key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">,</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="n">n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">max_number</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="n">copy_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">copy_keys</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">all_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="n">new_series</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_series</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_series</span><span class="p">):</span>

            <span class="n">new_number</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">max_number</span>

            <span class="n">series_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">series_keys</span><span class="p">):</span>

                <span class="c1">#msg = &#39;Copying series &#39; + str(s+1) + &#39; of &#39; + str(len(all_series))</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Copying series &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SeriesDescription&#39;</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_series</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">series_keys</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span>

                <span class="n">new_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span>
                <span class="n">instance_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">instance_uid</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_series</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_number</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
                        <span class="n">attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">],</span> 
                        <span class="n">values</span> <span class="o">+</span> <span class="p">[</span><span class="n">new_series</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">new_number</span><span class="p">,</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">new_key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

                <span class="c1"># Get new data for the dataframe</span>
                
                <span class="n">copy_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">copy_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_key</span><span class="p">)</span>

        <span class="c1"># Update the dataframe in the index</span>

        <span class="c1"># If the study is empty and new series have been added</span>
        <span class="c1"># then delete the row </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">copy_keys</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">target_key</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">+=</span> <span class="n">copy_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">+=</span> <span class="n">copy_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_series</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_series</span></div>


<div class="viewcode-block" id="Manager.copy_to_patient"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.copy_to_patient">[docs]</a>    <span class="k">def</span> <span class="nf">copy_to_patient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">target_key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy studies to another patient&quot;&quot;&quot;</span>

        <span class="n">attributes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_header</span><span class="p">(</span><span class="n">target_key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">copy_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">copy_keys</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">all_studies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">studies</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="n">new_studies</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_studies</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">study</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_studies</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">series</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">study</span><span class="p">):</span>
                <span class="n">new_series_uid</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">):</span>
                    <span class="n">new_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span>
                    <span class="n">instance_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">instance_uid</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">)</span>
                        <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_studies</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_series_uid</span>
                        <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span>
                        <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span> 
                            <span class="n">attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">],</span> 
                            <span class="n">values</span> <span class="o">+</span> <span class="p">[</span><span class="n">new_studies</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">new_series_uid</span><span class="p">,</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                            <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">new_key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

                    <span class="c1"># Get new data for the dataframe</span>
                    <span class="n">copy_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">copy_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_key</span><span class="p">)</span>

        <span class="c1"># Update the dataframe in the index</span>

        <span class="c1"># If the patient is empty and new studies have been added</span>
        <span class="c1"># then delete the row </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">copy_keys</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">target_key</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">target_key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">+=</span> <span class="n">copy_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">+=</span> <span class="n">copy_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_studies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_studies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_studies</span></div>

<div class="viewcode-block" id="Manager.copy_to_database"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.copy_to_database">[docs]</a>    <span class="k">def</span> <span class="nf">copy_to_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy patient to the database&quot;&quot;&quot;</span>

        <span class="n">copy_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">copy_keys</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">all_patients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patients</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="n">new_patients</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_patients</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">patient</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_patients</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">patient</span><span class="o">=</span><span class="n">patient</span><span class="p">)</span>
            <span class="n">new_patient_uid</span> <span class="o">=</span> <span class="n">new_patients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">new_patient_name</span> <span class="o">=</span> <span class="s1">&#39;Copy of &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">study</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">studies</span><span class="p">(</span><span class="n">patient</span><span class="p">):</span>
                <span class="n">new_study_uid</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">sery</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">study</span><span class="p">):</span>
                    <span class="n">new_series_uid</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">sery</span><span class="p">):</span>
                        <span class="n">new_instance_uid</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">new_uid</span><span class="p">()</span>
                        <span class="n">new_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span>
                        <span class="n">instance_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">instance_uid</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                            <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_patient_uid</span>
                            <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_study_uid</span> 
                            <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_series_uid</span>
                            <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_instance_uid</span>
                            <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_patient_name</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                            <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span> 
                                <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">],</span> 
                                <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">+</span><span class="p">[</span><span class="n">new_patient_uid</span><span class="p">,</span> <span class="n">new_study_uid</span><span class="p">,</span> <span class="n">new_series_uid</span><span class="p">,</span> <span class="n">new_instance_uid</span><span class="p">,</span> <span class="n">new_patient_name</span><span class="p">])</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                                <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">new_key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

                        <span class="c1"># Get new data for the dataframe</span>
                        <span class="n">copy_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                        <span class="n">copy_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_key</span><span class="p">)</span>

        <span class="c1"># Update the dataframe in the index</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">+=</span> <span class="n">copy_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">+=</span> <span class="n">copy_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_patients</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_patients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_patients</span></div>
            

<div class="viewcode-block" id="Manager.drop_if_missing"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.drop_if_missing">[docs]</a>    <span class="k">def</span> <span class="nf">drop_if_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">):</span>
        <span class="c1"># If the series was empty - now it has an instance so the original row can be removed</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Manager.move_to_series"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.move_to_series">[docs]</a>    <span class="k">def</span> <span class="nf">move_to_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy datasets to another series&quot;&quot;&quot;</span>

        <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_keys</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Moving data to a series that does not exist in the database&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">attributes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_header</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">,</span> <span class="s1">&#39;InstanceNumber&#39;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="n">n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">max_number</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        
        <span class="n">copy_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">copy_keys</span> <span class="o">=</span> <span class="p">[]</span>       

        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>

            <span class="c1"># self.status.progress(i+1, len(keys), message=&#39;Moving dataset..&#39;)</span>

            <span class="c1"># If this is the last instance in the series,</span>
            <span class="c1"># keep the series as an empty series.</span>
            <span class="n">source_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span>
            <span class="n">source_series</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">removed</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SeriesInstanceUID</span> <span class="o">==</span> <span class="n">source_series</span><span class="p">)</span>
            <span class="n">source_series_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SOPInstanceUID</span><span class="p">[</span><span class="n">source_series</span><span class="p">]</span>
            <span class="n">source_series_instances_cnt</span> <span class="o">=</span> <span class="n">source_series_instances</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">source_series_instances_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SeriesDescription&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">]</span>
                <span class="n">copy_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">())</span>
                <span class="n">copy_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

            <span class="n">instance_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span> 
            <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">instance_uid</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SeriesDescription&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">+</span> <span class="n">max_number</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">):</span>
                    <span class="c1">#self.register.loc[key, self.columns] = row</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_if_missing</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If the dataset has not yet been edited</span>
                    <span class="c1"># find the placeholder row and copy the data</span>
                    <span class="c1">#placeholder = (self.register.SOPInstanceUID == instance_uid) &amp; (self.register.placeholder)</span>
                    <span class="c1">#placeholder = placeholder[placeholder]</span>
                    <span class="n">placeholder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SOPInstanceUID</span> <span class="o">==</span> <span class="n">instance_uid</span><span class="p">]</span>
                    <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="p">[</span><span class="n">placeholder</span><span class="o">.</span><span class="n">placeholder</span><span class="p">]</span>
                    <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1">#self.register.loc[placeholder, self.columns] = row</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="c1"># remove the current row and make the placeholder row current</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># self.register.at[key, &#39;removed&#39;] = True</span>
                    <span class="c1"># copy_data.append(row)</span>
                    <span class="c1"># copy_keys.append(self.new_key())</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># If the value has changed before.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">):</span> 
                    <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span> 
                        <span class="n">attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;InstanceNumber&#39;</span><span class="p">],</span> 
                        <span class="n">values</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">+</span> <span class="n">max_number</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="c1"># for i, col in enumerate(attributes):</span>
                    <span class="c1">#     if col in self.columns:</span>
                    <span class="c1">#         self.register.at[key,col] = values[i]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_if_missing</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>

                <span class="c1"># If this is the first change, then save results in a copy.</span>
                <span class="k">else</span><span class="p">:</span>  
                    <span class="c1"># If the dataset has not yet been edited</span>
                    <span class="c1"># find the placeholder row and copy the data</span>
                    <span class="c1"># placeholder = (self.register.SOPInstanceUID == instance_uid) &amp; (self.register.placeholder)</span>
                    <span class="c1"># placeholder = placeholder[placeholder]</span>
                    <span class="n">placeholder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SOPInstanceUID</span> <span class="o">==</span> <span class="n">instance_uid</span><span class="p">]</span>
                    <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="p">[</span><span class="n">placeholder</span><span class="o">.</span><span class="n">placeholder</span><span class="p">]</span>
                    <span class="n">new_key</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1">#new_key = self.new_key()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
                        <span class="n">attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;InstanceNumber&#39;</span><span class="p">],</span> 
                        <span class="n">values</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">max_number</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">new_key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

                    <span class="c1"># Get new data for the dataframe</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="c1">#self.register.loc[new_key, self.columns] = row</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="c1"># remove the current row and make the placeholder row current</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># self.register.at[key,&#39;removed&#39;] = True</span>
                    <span class="c1"># copy_data.append(row)</span>
                    <span class="c1"># copy_keys.append(new_key)</span>

        <span class="c1"># Update the dataframe in the index</span>

        <span class="c1"># If the series is empty and new instances have been added</span>
        <span class="c1"># then delete the row </span>
        <span class="k">if</span> <span class="n">copy_keys</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_if_missing</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">+=</span> <span class="n">copy_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">+=</span> <span class="n">copy_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="Manager.move_to_study"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.move_to_study">[docs]</a>    <span class="k">def</span> <span class="nf">move_to_study</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy series to another study&quot;&quot;&quot;</span>

        <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">study</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

        <span class="n">attributes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">study_header</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">,</span> <span class="s1">&#39;SeriesNumber&#39;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="n">n</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">max_number</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        
        <span class="n">copy_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">copy_keys</span> <span class="o">=</span> <span class="p">[]</span>       

        <span class="n">all_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_series</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_series</span><span class="p">),</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Moving series..&#39;</span><span class="p">)</span>
            <span class="n">new_number</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">max_number</span>

            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">)</span>

            <span class="c1"># If this is the last series in the study</span>
            <span class="c1"># Keep the study as an empty study</span>
            <span class="n">source_study</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span>
            <span class="n">source_study_series</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">removed</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">StudyInstanceUID</span> <span class="o">==</span> <span class="n">source_study</span><span class="p">)</span>
            <span class="n">source_study_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SeriesInstanceUID</span><span class="p">[</span><span class="n">source_study_series</span><span class="p">]</span>
            <span class="n">source_study_series_cnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_study_series</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">source_study_series_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">]</span>
                <span class="n">copy_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">())</span>
                <span class="n">copy_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                
            <span class="c1"># Now move the instances one by one</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

                <span class="n">instance_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">instance_uid</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyDescription&#39;</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyDate&#39;</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_number</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">):</span>
                        <span class="c1">#self.register.loc[key, self.columns] = row</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">drop_if_missing</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If the dataset has not yet been edited</span>
                        <span class="c1"># find the placeholder row and copy the data</span>
                        <span class="c1"># placeholder = (self.register.SOPInstanceUID == instance_uid) &amp; (self.register.placeholder)</span>
                        <span class="c1"># placeholder = placeholder[placeholder]</span>
                        <span class="n">placeholder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SOPInstanceUID</span> <span class="o">==</span> <span class="n">instance_uid</span><span class="p">]</span>
                        <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="p">[</span><span class="n">placeholder</span><span class="o">.</span><span class="n">placeholder</span><span class="p">]</span>
                        <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1">#self.register.loc[placeholder, self.columns] = row</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="c1"># remove the current row and make the placeholder row current</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1"># self.register.at[key,&#39;removed&#39;] = True</span>
                        <span class="c1"># copy_data.append(row)</span>
                        <span class="c1"># copy_keys.append(self.new_key())</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="c1"># If the value has changed before.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">):</span> 
                        <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span> 
                            <span class="n">attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">],</span> 
                            <span class="n">values</span> <span class="o">+</span> <span class="p">[</span><span class="n">new_number</span><span class="p">])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                            <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="c1"># for i, col in enumerate(attributes):</span>
                        <span class="c1">#     if col in self.columns:</span>
                        <span class="c1">#         self.register.at[key,col] = values[i]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">drop_if_missing</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">)</span>

                    <span class="c1"># If this is the first change, then save results in a copy.</span>
                    <span class="k">else</span><span class="p">:</span>  
                        <span class="c1"># If the dataset has not yet been edited</span>
                        <span class="c1"># find the placeholder row and copy the data</span>
                        <span class="c1"># placeholder = (self.register.SOPInstanceUID == instance_uid) &amp; (self.register.placeholder)</span>
                        <span class="c1"># placeholder = placeholder[placeholder]</span>
                        <span class="n">placeholder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SOPInstanceUID</span> <span class="o">==</span> <span class="n">instance_uid</span><span class="p">]</span>
                        <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="p">[</span><span class="n">placeholder</span><span class="o">.</span><span class="n">placeholder</span><span class="p">]</span>
                        <span class="n">new_key</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1">#new_key = self.new_key()</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
                            <span class="n">attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SeriesNumber&#39;</span><span class="p">],</span> 
                            <span class="n">values</span> <span class="o">+</span> <span class="p">[</span><span class="n">new_number</span><span class="p">])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                            <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">new_key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

                        <span class="c1"># Get new data for the dataframe</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                        <span class="c1">#self.register.loc[new_key, self.columns] = row</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   
                        <span class="c1"># remove the current row and make the placeholder row current</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="c1"># self.register.at[key,&#39;removed&#39;] = True</span>
                        <span class="c1"># copy_data.append(row)</span>
                        <span class="c1"># copy_keys.append(new_key)</span>

        <span class="c1"># Update the dataframe in the index</span>
        <span class="c1"># If the target study was empty and new series have been added</span>
        <span class="c1"># then delete the row </span>
        <span class="k">if</span> <span class="n">copy_keys</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_if_missing</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">+=</span> <span class="n">copy_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">+=</span> <span class="n">copy_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_series</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_series</span></div>


<div class="viewcode-block" id="Manager.move_to_patient"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.move_to_patient">[docs]</a>    <span class="k">def</span> <span class="nf">move_to_patient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy series to another study&quot;&quot;&quot;</span>

        <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">patient</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

        <span class="n">attributes</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_header</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">copy_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">copy_keys</span> <span class="o">=</span> <span class="p">[]</span>  

        <span class="n">all_studies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">studies</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">study</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_studies</span><span class="p">):</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_studies</span><span class="p">),</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Moving study..&#39;</span><span class="p">)</span>

            <span class="c1"># If this is the last study in the patient</span>
            <span class="c1"># Keep the patient as an empty patient</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">study</span><span class="o">=</span><span class="n">study</span><span class="p">)</span>
            <span class="n">source_patient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">]</span>
            <span class="n">source_patient</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">removed</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">PatientID</span> <span class="o">==</span> <span class="n">source_patient</span><span class="p">)</span>
            <span class="n">source_patient_studies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">StudyInstanceUID</span><span class="p">[</span><span class="n">source_patient</span><span class="p">]</span>
            <span class="n">source_patient_studies_cnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_patient_studies</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">source_patient_studies_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">]</span>
                <span class="n">copy_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">())</span>
                <span class="n">copy_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

            <span class="c1">#for series in self.series(study):</span>
            <span class="k">for</span> <span class="n">series</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">series</span><span class="p">):</span>

                    <span class="n">instance_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">instance_uid</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientID&#39;</span><span class="p">)</span>
                        <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;PatientName&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">):</span>
                            <span class="c1">#self.register.loc[key, self.columns] = row</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">drop_if_missing</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># If the dataset has not yet been edited</span>
                            <span class="c1"># find the placeholder row and copy the data</span>
                            <span class="c1">#placeholder = (self.register.SOPInstanceUID == instance_uid) &amp; (self.register.placeholder)</span>
                            <span class="c1">#placeholder = placeholder[placeholder]</span>
                            <span class="n">placeholder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SOPInstanceUID</span> <span class="o">==</span> <span class="n">instance_uid</span><span class="p">]</span>
                            <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="p">[</span><span class="n">placeholder</span><span class="o">.</span><span class="n">placeholder</span><span class="p">]</span>
                            <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1">#self.register.loc[placeholder, self.columns] = row</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> 
                                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="c1"># remove the current row and make the placeholder row current</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">placeholder</span><span class="p">,</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="c1"># self.register.at[key,&#39;removed&#39;] = True</span>
                            <span class="c1"># copy_data.append(row)</span>
                            <span class="c1"># copy_keys.append(self.new_key())</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="c1"># If the value has changed before.</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">):</span> 
                            <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                                <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> 
                                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="c1"># for i, col in enumerate(attributes):</span>
                            <span class="c1">#     if col in self.columns:</span>
                            <span class="c1">#         self.register.at[key,col] = values[i]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">drop_if_missing</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span>

                        <span class="c1"># If this is the first change, then save results in a copy.</span>
                        <span class="k">else</span><span class="p">:</span>  

                            <span class="c1"># If the dataset has not yet been edited</span>
                            <span class="c1"># find the placeholder row and copy the data</span>
                            <span class="c1"># placeholder = (self.register.SOPInstanceUID == instance_uid) &amp; (self.register.placeholder)</span>
                            <span class="c1"># placeholder = placeholder[placeholder]</span>
                            <span class="n">placeholder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SOPInstanceUID</span> <span class="o">==</span> <span class="n">instance_uid</span><span class="p">]</span>
                            <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="p">[</span><span class="n">placeholder</span><span class="o">.</span><span class="n">placeholder</span><span class="p">]</span>
                            <span class="n">new_key</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1">#new_key = self.new_key()</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                            <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                                <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">new_key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

                            <span class="c1"># Get new data for the dataframe</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                            <span class="c1">#self.register.loc[new_key, self.columns] = row</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> 
                                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="c1"># remove the current row and make the placeholder row current</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                            <span class="c1"># self.register.at[key,&#39;removed&#39;] = True</span>
                            <span class="c1"># copy_data.append(row)</span>
                            <span class="c1"># copy_keys.append(new_key)</span>

            <span class="c1"># Update the dataframe in the index</span>

            <span class="c1"># If the patient is empty and new studies have been added</span>
            <span class="c1"># then delete the row </span>
            <span class="k">if</span> <span class="n">copy_keys</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drop_if_missing</span><span class="p">(</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">+=</span> <span class="n">copy_keys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_data</span> <span class="o">+=</span> <span class="n">copy_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_studies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_studies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_studies</span></div>


<div class="viewcode-block" id="Manager.move_to"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.move_to">[docs]</a>    <span class="k">def</span> <span class="nf">move_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Patient&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_to_patient</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Study&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_to_study</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Series&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_to_series</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;Instance&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot move to an instance. Please move to series, study or patient.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Manager.set_values"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.set_values">[docs]</a>    <span class="k">def</span> <span class="nf">set_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set values in a dataset&quot;&quot;&quot;</span>

        <span class="n">uids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PatientID&#39;</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">]</span>
        <span class="n">uids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">uids</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">uids</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;UIDs cannot be set using set_value(). Use copy_to() or move_to() instead.&#39;</span><span class="p">)</span>

        <span class="c1">#copy_data = []</span>
        <span class="c1">#copy_keys = []</span>

        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>

            <span class="n">instance_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">instance_uid</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">new_dataset</span><span class="p">(</span><span class="s1">&#39;MRImage&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">instance_uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># instance not yet created</span>
                    <span class="n">series_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SeriesInstanceUID&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">series_uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">study_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;StudyInstanceUID&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">study_uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">patient_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;PatientUID&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">patient_uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">instance_uid</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_instance</span><span class="p">(</span><span class="s1">&#39;Database&#39;</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">instance_uid</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_instance</span><span class="p">(</span><span class="n">patient_uid</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">instance_uid</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_instance</span><span class="p">(</span><span class="n">study_uid</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">instance_uid</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_instance</span><span class="p">(</span><span class="n">series_uid</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#self.set_dataset(instance_uid, ds)</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_instance_dataset</span><span class="p">(</span><span class="n">instance_uid</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="c1"># If the value has changed before</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">):</span> 
                <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                <span class="c1"># Get new data for the dataframe</span>
                <span class="c1"># The variable values can&#39;t be used - if it is a custom attribute</span>
                <span class="c1"># such as affine_matrix the this will have made other changes on the fly</span>
                <span class="c1"># such as ImageOrientationPatient and SliceLocation</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># for i, col in enumerate(attributes):</span>
                <span class="c1">#     if col in self.columns:</span>
                <span class="c1">#         self.register.at[key,col] = values[i]</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="n">key</span>
            <span class="c1"># If this is the first change, then save results in a copy</span>
            <span class="k">else</span><span class="p">:</span>  
    
                <span class="c1"># If the dataset has not yet been edited</span>
                <span class="c1"># find the placeholder row and copy the data</span>
                <span class="n">placeholder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SOPInstanceUID</span> <span class="o">==</span> <span class="n">instance_uid</span><span class="p">]</span>
                <span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="p">[</span><span class="n">placeholder</span><span class="o">.</span><span class="n">placeholder</span><span class="p">]</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#new_key = self.new_key()</span>
        
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">new_key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

                <span class="c1"># Get new data for the dataframe</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="c1"># Note this is 10x faster than self.register.loc[new_key, self.columns] = row</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># remove the current row and make the placeholder row current</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">new_key</span><span class="p">,</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># self.register.at[key,&#39;removed&#39;] = True</span>
                <span class="c1"># copy_data.append(row)</span>
                <span class="c1"># copy_keys.append(new_key)</span>

        <span class="c1">#self._new_keys += copy_keys</span>
        <span class="c1">#self._new_data += copy_data</span>
        <span class="c1">#self.extend()</span>

        
        <span class="k">return</span> <span class="n">new_key</span></div>

 
<div class="viewcode-block" id="Manager.get_values"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.get_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keys</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="k">return</span>

        <span class="c1"># Single attribute</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">attributes</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
                <span class="c1"># trick to get unique elements</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">value</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
                    <span class="n">instance_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">instance_uid</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">value</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="c1"># added 30/12/22</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="c1"># Multiple attributes</span>
        <span class="c1"># Create a np array v with values for each instance and attribute</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
                <span class="n">instance_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">instance_uid</span><span class="p">,</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">SOPInstanceUID</span> <span class="o">==</span> <span class="n">instance_uid</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Multiple instances with the same SOPInstanceUID </span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="n">instance_uid</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">instances</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
                    <span class="k">raise</span> <span class="n">DatabaseCorrupted</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>

        <span class="c1"># Return a list with unique values for each attribute</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">va</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span><span class="n">a</span><span class="p">]</span>
            <span class="n">va</span> <span class="o">=</span> <span class="n">va</span><span class="p">[</span><span class="n">va</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
            <span class="n">va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">va</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">va</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">va</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">va</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">va</span> <span class="o">=</span> <span class="n">va</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">va</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">va</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span> 
                    <span class="n">va</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="c1"># added 30/12/22</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">va</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span></div>


<div class="viewcode-block" id="Manager.import_datasets"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.import_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">import_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>

        <span class="c1"># Read manager data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">read_dataframe</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Do not import SOPInstances that are already in the database</span>
        <span class="n">uids</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">SOPInstanceUID</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">uids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">do_not_import</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="s1">&#39;SOPInstanceUID&#39;</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">SOPInstanceUID</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">do_not_import</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Add those that are left to the database</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_key</span><span class="p">()</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">dbdataset</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="n">new_key</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">{</span><span class="n">file</span><span class="p">:</span><span class="n">new_key</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="n">df</span><span class="p">])</span>

        <span class="c1"># return the UIDs of the new instances</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">SOPInstanceUID</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>


<div class="viewcode-block" id="Manager.export_datasets"><a class="viewcode-back" href="../../dbdicom.html#dbdicom.manager.Manager.export_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">export_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uids</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepaths</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span>
        <span class="n">database</span><span class="o">.</span><span class="n">import_datasets</span><span class="p">(</span><span class="n">files</span><span class="p">)</span></div>


<span class="c1">#   Helper functions to hide the register from classes other than manager</span>
<span class="c1">#   Consider removing after eliminating dataframe</span>

    <span class="k">def</span> <span class="nf">_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">empty</span>

    <span class="k">def</span> <span class="nf">_dbloc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">removed</span><span class="o">==</span><span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">,:]</span>

    <span class="k">def</span> <span class="nf">_loc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">removed</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">==</span><span class="n">uid</span><span class="p">)</span>  

    <span class="k">def</span> <span class="nf">_extract_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, QIB-Sheffield.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>